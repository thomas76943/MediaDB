{% extends "media/base.html" %}
{% load media_tags %}
{% block title %}{{profileSection.sectionName}}{% endblock title %}
{% block content %}

    <!-- Make Profile Sections Sortable -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <div class="container profileSection">
        <a href="/user/{{ profileSection.profile.user.username }}">Back to Profile Page</a>
    </div>

    <div class="container profileSection" id="nameChangeContainer">
        <h5 class="font-weight-bold border-bottom mb-0">Change Name</h5><br>
            <form id="changeName">
                {%  csrf_token %}
                <div class="form-outline mb-4">
                  <textarea class="form-control" id="nameChangeArea" rows="1" style="color: white">{{ profileSection.sectionName }}</textarea>
                </div>
                <div class="form-group">
                    <input type="submit" id="submitNameChange" class="btn btn-primary btn-raised" value="Change">
                </div>
            </form>
    </div>

    <!-- Change Name Script -->
    <script type="text/javascript">

        var frm = $('#changeName')

        console.log(frm)
        frm.submit(function(e) {
            e.preventDefault();
            $.ajax({
                url:document.URL,
                type : "POST",
                data : {
                    'newName': document.querySelector('#nameChangeArea').value,
                    'csrfmiddlewaretoken' : '{{ csrf_token }}',
                },
                success: setTimeout(function(){
                    /*
                    $('#sectionViewer').load(' #sectionViewer', function (){$(this).children().unwrap()})
                    $('#nameChangeContainer').load(' #nameChangeContainer', function (){$(this).children().unwrap()})
                    */
                    location.reload()
                }, 1000),
            })
            return false;
        })

    </script>

    <!-- View and Reorder the Media in the Profile Section -->
    <div class="container profileSection" id="sectionViewer">
        <h5 class="font-weight-bold border-bottom mb-0">{{ profileSection.sectionName }}</h5>
        <div class="scroller">
            <ul class="hs full" style="list-style: none" id="sectionID">
                {% for entry in entries %}
                    {%  if entry.film != NULL %}
                        <li id="entry_{{ entry.id }}" class="ui-state-default">
                            <div class="bottomOverlay">
                                <a class="item" href="/films/{{ entry.film.slug }}">
                                    <img class="item posterSmall" src="{{entry.film.poster.url}}" alt="{{entry.film.title}}">
                                </a>
                                <div class="content">
                                   <button id="f-{{ entry.film.slug }}" onClick="test(this.id)" class="btn btn-danger btn-raised" value="Remove">Remove</button>
                                </div>
                            </div>
                        </li>
                    {% endif %}
                    {%  if entry.television != NULL %}
                        <li id="entry_{{ entry.id }}" class="ui-state-default">
                            <div class="bottomOverlay">
                                <a class="item" href="/tv/{{ entry.television.slug }}">
                                    <img class="item posterSmall" src="{{entry.television.poster.url}}" alt="{{entry.television.title}}">
                                </a>
                                <div class="content">
                                   <button id="t-{{ entry.television.slug }}" onClick="test(this.id)" class="btn btn-danger btn-raised" value="Remove">Remove</button>
                                </div>
                            </div>
                        </li>
                    {% endif %}
                    {%  if entry.videoGame != NULL %}
                        <li id="entry_{{ entry.id }}" class="ui-state-default">
                            <div class="bottomOverlay">
                                <a class="item" href="/video-games/{{ entry.videoGame.slug }}">
                                    <img class="item posterSmall" src="{{entry.videoGame.poster.url}}" alt="{{entry.videoGame.title}}">
                                </a>
                                <div class="content">
                                   <button id="v-{{ entry.videoGame.slug }}" onClick="test(this.id)" class="btn btn-danger btn-raised" value="Remove">Remove</button>
                                </div>
                            </div>
                        </li>
                    {% endif %}
                    {%  if entry.book != NULL %}
                        <li id="entry_{{ entry.id }}" class="ui-state-default">
                            <div class="bottomOverlay">
                                <a class="item" href="/books/{{ entry.book.slug }}">
                                    <img class="item posterSmall" src="{{entry.book.image.url}}" alt="{{entry.book.title}}">
                                </a>
                                <div class="content">
                                   <button id="b-{{ entry.book.slug }}" onClick="test(this.id)" class="btn btn-danger btn-raised" value="Remove">Remove</button>
                                </div>
                            </div>
                        </li>
                    {% endif %}
                    {%  if entry.webSeries != NULL %}
                        <li id="entry_{{ entry.id }}" class="ui-state-default">
                          <div class="bottomOverlay">
                                <a class="item" href="/web-series/{{ entry.webSeries.slug }}">
                                    <img class="item posterSmall" src="{{entry.webSeries.poster.url}}" alt="{{entry.webSeries.title}}">
                                </a>
                               <div class="content">
                                   <button id="w-{{ entry.webSeries.slug }}" onClick="test(this.id)" class="btn btn-danger btn-raised" value="Remove">Remove</button>
                                </div>
                          </div>
                        </li>
                    {% endif %}
                    <!--
                    -->
                {% endfor %}
            </ul>
            <!-- Changing the Order of the Section Script -->
            <script type="text/javascript" language="javascript">
              $(document).ready(function() {
                $("#sectionID").sortable({
                    axis:'x',
                    update: function(event, ui) {
                        var data = $(this).sortable('serialize',{attribute:"id"});
                        $.ajax({
                          url: "/profile-section/{{ profileSection.slug }}",
                          type: "POST",
                          data: { 'changing':"confirm", 'content': data, 'csrfmiddlewaretoken' : '{{ csrf_token }}' }
                        });
                    },
                }).disableSelection();
              });

              function test(media) {
                console.log(media)
                $.ajax({
                    url: "/profile-section/{{ profileSection.slug }}",
                    type: "POST",
                    data: { 'removeMedia': media, 'csrfmiddlewaretoken': '{{ csrf_token }}', },
                    success: setTimeout(function () {
                        location.reload()
                    }, 1000),
                })};

            </script>
        </div>
    </div>

    <!-- Search for new media to add to the Profile Section -->
    <div class="container profileSection">
        <h5 class="font-weight-bold border-bottom mb-0">Add {{ profileSection.type }}</h5><br>
        <form class="input-group input-group-lg">
            <input class="form-control" style="color: white; max-width: 600px" type="search" id="searchMedia" name="searchMedia" placeholder="Search for {{ profileSection.type }}...">
        </form>

        <div id="results" style="padding-top: 15px">
        </div>

    </div>

    <!-- Live Search + Add Media Scripts -->
    <script>
        const data = '{{ media }}'
        /*console.log(data)*/

        const rdata = JSON.parse(data.replace(/&quot;/g, '"'))
        /*console.log(rdata)*/

        const input = document.getElementById('searchMedia')

        let filteredArr = []

        input.addEventListener('keyup', (e)=>{
            results.innerHTML = ""
            filteredArr = rdata.filter(item=> (item['title']).toLowerCase().includes(e.target.value.toLowerCase()) )
            if (filteredArr.length > 0){
                filteredArr.map(item=>{
                    //Dynamically creating buttons for every search item
                    results.innerHTML += `
                        <button id="${item['slug']}" class="btn btn-primary btn-raised" style="background: none; border: none; color:white;">Add</button>
                        <a href="/films/${item['slug']}"> ${item['title']}</a>
                        <br><br>`
                })

                //Function to handle whichever button is pressed and to then make the AJAX POST request
                $('#results').unbind().on('click', 'button', function(e)  {
                    e.preventDefault()
                    var mediaToAdd = $(this).attr('id');
                    console.log("Clicked:", mediaToAdd)

                    $.ajax({
                        url: "/profile-section/{{ profileSection.slug }}",
                        type: "POST",
                        data: {
                            'addMedia': mediaToAdd,
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                        },
                        success: setTimeout(function () {
                            location.reload()
                        }, 1000),
                    })
                });
            } else {
                results.innerHTML = "No results"
            }
        })
    </script>

    <!-- Modal Styling -->
    <style>

        /* The Modal (background) */
        .modal {
          display: none; /* Hidden by default */
          position: fixed; /* Stay in place */
          z-index: 1; /* Sit on top */
          padding-top: 200px; /* Location of the box */
          left: 0;
          top: 0;
          width: 100%; /* Full width */
          height: 100%; /* Full height */
          overflow: auto; /* Enable scroll if needed */
          background-color: rgb(0,0,0); /* Fallback color */
          background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content */
        .modal-content {
          position: relative;
          background-color: #fefefe;
          margin: auto;
          padding: 0;
          border: 3px solid #888;
          width: 50%;
          max-width: 610px;
          min-width: 330px;
          box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
          -webkit-animation-name: animatetop;
          -webkit-animation-duration: 0.4s;
          animation-name: animatetop;
          animation-duration: 0.4s
        }

        div.container.profileSection.modalSection {
            margin-bottom: 0;
        }

        /* Add Animation */
        @-webkit-keyframes animatetop {
          from {top:-300px; opacity:0}
          to {top:0; opacity:1}
        }

        @keyframes animatetop {
          from {top:-300px; opacity:0}
          to {top:0; opacity:1}
        }

        /* The Close Button */
        .close {
        }

        .close:hover,
        .close:focus {
          color: #000;
          text-decoration: none;
          cursor: pointer;
        }

        .modal-header {
          padding: 2px 16px;
          background-color: #04b877;
          color: white;
        }

        .modal-body {padding: 2px 16px;}

        .modal-footer {
          padding: 2px 16px;
          background-color: #10b310;
          color: white;
        }
    </style>

    <!-- Delete Section Button -->
    <div class="container profileSection">
        <div class="form-group" style="padding-top: 20px">
            <button id="myBtn" style="background: none; border: none; color:white;">
                <input type="submit" class="btn btn-danger btn-raised" value="DELETE SECTION">
            </button>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="myModal" class="modal">

      <!-- Modal content -->
      <div class="modal-content">
        <div class="container profileSection modalSection">
            <h5 class="font-weight-bold border-bottom mb-0">Deleting: {{ profileSection.sectionName }}</h5><br>
            <h5 class="font-weight-bold">Are you sure?</h5><br>

            <form id="deleteProfileSection">
                {%  csrf_token %}
                <div class="form-group">
                    <input type="submit" class="btn btn-danger btn-raised" value="Delete">
                    <span class="close btn btn-default" style="color: white">X</span>
                </div>
            </form>

            <script type="text/javascript">

                var frm = $('#deleteProfileSection')

                console.log(frm)
                frm.submit(function(e) {
                    $.ajax({
                        url : "/profile-section/{{ profileSection.slug }}",
                        type : "POST",
                        data : {
                            'delete': 'confirm',
                            'csrfmiddlewaretoken' : '{{ csrf_token }}',
                        },
                        success: setTimeout(function(){// wait for 5 secs(2)
                            location.reload(); // then reload the page.(3)
                        }, 0.01),
                    })
                    return false;
                })

            </script>

          </div>

        </div>
      </div>
    </div>

    <!-- Modal Script -->
    <script>
    // Get the modal
    var modal = document.getElementById("myModal");

    // Get the button that opens the modal
    var btn = document.getElementById("myBtn");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks the button, open the modal
    btn.onclick = function() {
      modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
      modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }
    </script>

{% endblock %}